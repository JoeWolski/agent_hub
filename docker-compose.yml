services:
  codex:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BASE_IMAGE: "${BASE_IMAGE:-nvidia/cuda:12.2.2-cudnn8-devel-ubuntu22.04}"
    image: codex-ubuntu2204:latest
    init: true
    gpus: all
    working_dir: "${CONTAINER_PROJECT_PATH:-/home/codex/projects/project}"
    stdin_open: true
    tty: true
    environment:
      LOCAL_USER: "${LOCAL_USER:-codex}"
      LOCAL_GROUP: "${LOCAL_GROUP:-codex}"
      LOCAL_UID: "${LOCAL_UID:-1000}"
      LOCAL_GID: "${LOCAL_GID:-1000}"
      LOCAL_SUPP_GIDS: "${LOCAL_SUPP_GIDS:-}"
      LOCAL_SUPP_GROUPS: "${LOCAL_SUPP_GROUPS:-}"
      LOCAL_HOME: "${CONTAINER_HOME:-/home/codex}"
      LOCAL_UMASK: "${LOCAL_UMASK:-0022}"
      OPENAI_API_KEY: "${OPENAI_API_KEY:-}"
      HOME: "${CONTAINER_HOME:-/home/codex}"
      PATH: "${CONTAINER_HOME:-/home/codex}/.codex/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DRIVER_CAPABILITIES: all
    volumes:
      - "${CODEX_HOME_PATH:-/tmp/codex-home}:${CONTAINER_HOME:-/home/codex}"
      - "${PROJECT_PATH:-/tmp/cloned-repo-name}:${CONTAINER_PROJECT_PATH:-/home/codex/projects/project}"
      - "${CODEX_CONFIG_FILE:-./codex.config.toml}:${CONTAINER_HOME:-/home/codex}/.codex/config.toml:ro"
    command: ["codex"]
